{% extends 'base.html' %}
{% load static %}
{% block title %}대시보드{% endblock %}

{% block content %}
<style>
  /* === Dark UI (dashboard + leaderboard 공용) === */
  :root{
    --bg:#0b1220; --panel:#0f1729; --panel-2:#0b1327; --line:#1f2a44;
    --text:#e6edf7; --muted:#9fb0d1; --primary:#6aa3ff;
    --accent:#ffd166; --good:#22c55e; --bad:#ef4444; --ring:rgba(106,163,255,.35);
  }

  body { background: var(--bg); color: var(--text); }

  /* layout */
  .dash { color:#e6edf7; }
  .grid { display:grid; gap:16px; }
  .cards { grid-template-columns: repeat(4, minmax(0,1fr)); }
  .flex { display:flex; gap:16px; }
  .col { flex:1 1 0; }
  @media (max-width:1100px){ .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); } .flex{ flex-direction:column; } }
  @media (max-width:640px){ .cards{ grid-template-columns: 1fr; } }

  /* panels & kpis */
  .panel {
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid var(--line); border-radius:16px;
    box-shadow: 0 0 0 1px rgba(106,163,255,.06), 0 10px 30px rgba(0,0,0,.35);
  }
  .kpi { padding:18px; }
  .kpi h3 { margin:0 0 6px; color:var(--muted); font-size:13px; font-weight:600; letter-spacing:.2px;}
  .kpi .value { font-size:26px; font-weight:800; }
  .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .title { font-size:18px; font-weight:700; letter-spacing:.2px; }
  .sub { font-size:12px; color:var(--muted); }
  .pill { font-size:12px; color:#0b1220; background:var(--accent); padding:4px 8px; border-radius:999px; font-weight:700; }
  .badge { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #284173; color:#9fb0d1; background:#0a0f1f; }
  .ring { outline:2px solid var(--ring); outline-offset:-2px; border-radius:16px; }
  .pos { color:var(--good); } .neg { color:var(--bad); }

  /* tables */
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { padding:10px 12px; border-bottom:1px solid var(--line); font-size:13px; }
  .table th { color:var(--muted); text-align:left; font-weight:600; }
  .empty { color:var(--muted); font-size:14px; text-align:center; padding:16px; }

  /* progress */
  .progress-wrap { background:#0b1220; border:1px solid var(--line); border-radius:12px; padding:10px; }
  .progress { height:10px; background:#0a0f1f; border-radius:999px; overflow:hidden; }
  .bar { height:100%; background: linear-gradient(90deg, var(--primary), #8bb8ff); width: calc(var(--w, 0) * 1%); }

  /* leaderboard-specific (Bootstrap override) */
  .soft-card{
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid var(--line) !important;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    color: var(--text);
  }
  .soft-card .card-header{
    background: rgba(16, 23, 41, .6);
    border-bottom: 1px solid var(--line);
    color: var(--text);
  }
  .soft-card .card-header .small { color: var(--muted) !important; }

  .list-group-item{
    background-color: #0d1426 !important;
    color: var(--text) !important;
    border-color: var(--line) !important;
  }
  .list-group-item:hover{ background-color: #111b33 !important; }

  .badge.bg-light{
    background-color: #0a1020 !important;
    color: var(--muted) !important;
    border:1px solid var(--line);
  }
  .badge.bg-info{
    background-color: rgba(106,163,255,.18) !important;
    color: var(--text) !important;
    border:1px solid rgba(106,163,255,.35);
  }
  .badge.bg-primary{
    background-color: rgba(106,163,255,.25) !important;
    color: var(--text) !important;
    border:1px solid rgba(106,163,255,.45);
  }
  .badge.bg-danger{
    background-color: rgba(239,68,68,.18) !important;
    color: var(--text) !important;
    border:1px solid rgba(239,68,68,.35);
  }
  .rank-badge{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.12); }
  .avatar{
    background:#11192f !important;
    color:#c7d2fe !important;
    border:1px solid var(--line);
    width:34px;height:34px;border-radius:50%;
    display:inline-flex;align-items:center;justify-content:center;
    font-weight:700;
  }

  .text-muted{ color: var(--muted) !important; }
  .btn-outline-secondary{ color: var(--muted); border-color: var(--line); }
  .btn-outline-secondary:hover{ background:#0a1020; border-color:#2a3b63; color:#cfe1ff; }

  /* 내부 스크롤 영역 */
.scroll-y {
  --section-h: 320px;             /* 기본 높이 */
  max-height: var(--section-h);
  overflow: auto;
  overscroll-behavior: contain;
  border-radius: 12px;
}

/* 테이블 헤더 고정 */
.table thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #0d1426;            /* 다크 톤과 어울리게 */
  box-shadow: inset 0 -1px 0 var(--line);
}

/* 스크롤바 다크 테마 */
.scroll-y::-webkit-scrollbar { height: 10px; width: 10px; }
.scroll-y::-webkit-scrollbar-track { background: #0a1020; }
.scroll-y::-webkit-scrollbar-thumb { background: #223054; border-radius: 999px; }
.scroll-y::-webkit-scrollbar-thumb:hover { background: #2a3b63; }

/* 화면 작을 때 높이 줄이기 */
@media (max-width: 1100px){ .scroll-y { --section-h: 260px; } }
@media (max-width: 640px) { .scroll-y { --section-h: 220px; } }


/* Bootstrap 5 Table — Dark override */
.table{
  --bs-table-bg: #0d1426;
  --bs-table-color: #e6edf7;
  --bs-table-striped-bg: #0f152a;
  --bs-table-striped-color: #e6edf7;
  --bs-table-hover-bg: #111b33;
  --bs-table-hover-color: #e6edf7;
  --bs-table-border-color: #1f2a44;
  background-color: var(--bs-table-bg) !important;
  color: var(--bs-table-color) !important;
}
.table > :not(caption) > * > *{
  background-color: var(--bs-table-bg) !important;
  color: var(--bs-table-color) !important;
  border-color: var(--bs-table-border-color) !important;
}
/* (선택) 헤더를 좀 더 진하게 + sticky인 경우 어울리게 */
.table thead th{
  background: #0a1020 !important;
  color: #9fb0d1 !important;
  position: sticky; top: 0; z-index: 1;
  box-shadow: inset 0 -1px 0 #1f2a44;
}
/* (선택) zebra/hover 효과 */
.table-striped > tbody > tr:nth-of-type(odd){ background-color: var(--bs-table-striped-bg) !important; }
.table-hover > tbody > tr:hover{ background-color: var(--bs-table-hover-bg) !important; }


</style>



<div class="dash">
  <!-- 상단 KPI -->
  <div class="grid cards">
    <div class="panel kpi ring">
      <h3>현재 레벨</h3>
      <div class="value">Lv. {{ cur_level|default:profile.current_level|default:1 }}</div>
      <div class="sub">총 포인트 {{ total_points|default:profile.total_points|default:0 }} pt</div>
    </div>
    <div class="panel kpi">
      <h3>정답률</h3>
      <div class="value">{{ accuracy|default:0 }}%</div>
      <div class="sub">시도 {{ total_attempts|default:0 }} · 정답 {{ correct_answers|default:0 }}</div>
    </div>
    <div class="panel kpi">
      <h3>연속 활동</h3>
      <div class="value">{{ streak|default:profile.streak_days|default:0 }}일</div>
      <div class="sub">최근 30일 기준</div>
    </div>
    <div class="panel kpi">
      <h3>획득 업적</h3>
      <div class="value">{{ achievements_count|default:0 }}</div>
      <div class="sub">활성 업적 기준</div>
    </div>
  </div>

  <div class="flex" style="margin-top:16px;">
    <!-- 좌: 포인트 추이 + 최근 포인트 -->
    <div class="col panel" style="padding:18px;">
      <div class="header">
        <div class="title">최근 7일 포인트 추이</div>
      </div>
      <canvas id="chart7d" height="80"></canvas>

      {# 안전한 JSON 주입 #}
      {{ labels|json_script:"labels-json" }}
      {{ data_points|json_script:"points-json" }}

      <div class="header" style="margin-top:18px;">
        <div class="title">최근 포인트 내역</div>
        <span class="badge">최신 10개</span>
      </div>

      {% if recent_points %}
      <div class="scroll-y" aria-label="최근 포인트 내역 스크롤 영역">
        <table class="table table-striped table-hover">
          <thead><tr><th>일시</th><th>사유</th><th style="text-align:right;">포인트</th></tr></thead>
          <tbody>
          {% for p in recent_points %}
            <tr>
              <td>{{ p.activated_at|date:"Y-m-d H:i" }}</td>
              <td>{{ p.reason|default:"기타" }}</td>
              <td style="text-align:right;" class="{% if p.points >= 0 %}pos{% else %}neg{% endif %}">
                {% if p.points >= 0 %}+{% endif %}{{ p.points }}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="empty">최근 포인트 내역이 없습니다.</div>
      {% endif %}
    </div>

    <!-- 우: 레벨 진행도 + 미니 리더보드 -->
    <div class="col panel" style="padding:18px;">
      <div class="header">
        <div class="title">레벨 진행도</div>
        <span class="pill">현재 레벨: {{ cur_level }}</span>
      </div>
      <div class="progress-wrap">
        <div class="progress"><div class="bar" style="--w: {{ progress_rate|default:0 }};"></div></div>
        <div class="sub" style="margin-top:8px;">
          다음 레벨까지 <b>{{ points_to_next|default:0 }}</b> pt 남음 (기준: {{ total_points }} / {{ next_level_points }} pt)
        </div>
      </div>

      <div class="header" style="margin-top:18px;">
        <div class="title">미니 리더보드</div>
      </div>

      {% if leaderboard %}
      <div class="scroll-y" aria-label="미니 리더보드 스크롤 영역">
        <table class="table table-striped table-hover">
          <thead><tr><th>순위</th><th>사용자</th><th style="text-align:right;">포인트</th></tr></thead>
          <tbody>
          {% for row in leaderboard %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                {% if row.display_name %}@{{ row.display_name }}{% else %}익명{% endif %}
              </td>
              <td style="text-align:right;">{{ row.total|default:0 }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="empty">리더보드 데이터가 없습니다.</div>
      {% endif %}
    </div>
  </div>

  <!-- 최근 업적/레벨업/혜택 -->
  <div class="flex" style="margin-top:16px;">
    <div class="col panel" style="padding:18px;">
      <div class="header"><div class="title">최근 획득 업적</div><span class="badge">최신 5개</span></div>
      {% if recent_achievements %}
      <table class="table">
        <thead><tr><th>일시</th><th>업적</th><th>설명</th></tr></thead>
        <tbody>
        {% for ua in recent_achievements %}
          <tr>
            <td>{{ ua.earned_at|date:"Y-m-d H:i" }}</td>
            <td>{{ ua.achievement.title|default:ua.achievement.name }}</td>
            <td class="sub">{{ ua.achievement.description|default:"" }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="empty">최근 업적이 없습니다.</div>
      {% endif %}
    </div>

    <div class="col panel" style="padding:18px;">
      <div class="header"><div class="title">최근 레벨업</div><span class="badge">최신 5개</span></div>
      {% if recent_level_ups %}
      <table class="table">
        <thead><tr><th>일시</th><th>이전 → 이후</th><th style="text-align:right;">획득 포인트</th></tr></thead>
        <tbody>
        {% for lu in recent_level_ups %}
          <tr>
            <td>{{ lu.activated_at|date:"Y-m-d H:i" }}</td>
            <td>Lv. {{ lu.old_level }} → <b>Lv. {{ lu.new_level }}</b></td>
            <td style="text-align:right;">{{ lu.points_gained|default:"-" }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="empty">레벨업 기록이 없습니다.</div>
      {% endif %}

      <div class="header" style="margin-top:18px;"><div class="title">사용 가능 혜택</div></div>
      {% if available_benefits %}
      <table class="table">
        <thead><tr><th>혜택</th><th>조건</th><th style="text-align:right;">상태</th></tr></thead>
        <tbody>
        {% for b in available_benefits %}
          <tr>
            <td>{{ b.name }}</td>
            <td class="sub">Lv. {{ b.required_level }} / {{ b.required_points }} pt</td>
            <td style="text-align:right;">{{ b.is_active|yesno:"활성,비활성" }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="empty">현재 조건을 충족하는 혜택이 없습니다.</div>
      {% endif %}
    </div>
  </div>

  <!-- 업적 진행도 -->
  <div class="panel" style="padding:18px; margin-top:16px;">
    <div class="header"><div class="title">업적 진행도</div><span class="pill">실시간</span></div>
    {% if achievement_progress %}
      <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;">
      {% for ap in achievement_progress %}
        <div class="panel" style="padding:14px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div style="font-weight:700;">{{ ap.achievement.title|default:ap.achievement.name }}</div>
            <span class="badge">{{ ap.status }}</span>
          </div>
          <div class="sub" style="margin-bottom:8px;">
            목표: {{ ap.achievement.requirement_value }} · 현재: {{ ap.current_value }}
            {% if ap.achievement.achievement_type %} · 유형: {{ ap.achievement.achievement_type }}{% endif %}
          </div>
          <div class="progress-wrap">
            <div class="progress"><div class="bar" style="--w: {{ ap.progress }};"></div></div>
            <div class="sub" style="margin-top:6px;">진행률 {{ ap.progress }}%</div>
          </div>
        </div>
      {% endfor %}
      </div>
    {% else %}
      <div class="empty">표시할 업적이 없습니다.</div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    // JSON 안전 파싱
    const nodeLabels = document.getElementById('labels-json');
    const nodePoints = document.getElementById('points-json');
    const canvas = document.getElementById('chart7d');

    if (!canvas || !nodeLabels || !nodePoints) return;

    let labels, dataPoints;
    try {
      labels = JSON.parse(nodeLabels.textContent);
      dataPoints = JSON.parse(nodePoints.textContent);
    } catch (e) {
      console.error('차트 데이터 파싱 에러:', e);
      return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: '일별 포인트',
          data: dataPoints,
          tension: 0.35,
          borderWidth: 2,
          pointRadius: 3,
          fill: true,
          // 다크테마에서 또렷하게 보이도록 색 지정
          borderColor: '#6aa3ff',
          backgroundColor: 'rgba(106,163,255,.18)',
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#9fb0d1' }, grid: { color: '#14203b' } },
          y: { beginAtZero: true, ticks: { color: '#9fb0d1' }, grid: { color: '#14203b' } }
        }
      }
    });
  })();
</script>

{% endblock %}
