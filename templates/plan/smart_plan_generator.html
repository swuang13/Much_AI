{% extends "base.html" %}
{% load static %}

{% block title %}AI 맞춤형 자산 관리 계획 | Much{% endblock %}

{% block content %}
<!-- User Status Bar -->
{% if user.is_authenticated %}
<div class="user-status-bar mb-4">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <div class="user-info">
          <i class="fas fa-user-circle text-primary me-2"></i>
          <span class="fw-semibold">{{ user.first_name|default:user.username }}님, 환영합니다!</span>
          <span class="text-muted ms-2">AI가 맞춤형 계획을 생성해드립니다.</span>
        </div>
      </div>
      <div class="col-md-4 text-md-end">
        <a href="{% url 'logout' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>로그아웃
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Hero Section -->
<div class="hero-section mb-5">
  <div class="hero-container">
    <div class="container">
      <div class="row align-items-center min-height: 35vh;">
        <div class="col-lg-8">
          <div class="hero-content">
            <h1 class="hero-title">
              <i class="fas fa-robot me-3"></i>AI 맞춤형 자산 관리 계획
            </h1>
            <p class="hero-subtitle">
              월 소득과 거래내역을 분석하여<br>
              개인 맞춤형 저축, 지출, 청년 혜택 계획을 제안합니다.
            </p>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="hero-visual">
            <div class="hero-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Smart Plan Form -->
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="smart-plan-card">
        <div class="smart-plan-header">
          <h3 class="smart-plan-title">
            <i class="fas fa-magic me-2"></i>개인 정보 입력
          </h3>
          <p class="smart-plan-subtitle">
            AI가 더 정확한 계획을 생성할 수 있도록 정보를 입력해주세요.
          </p>
        </div>
        
        <form method="post" class="smart-plan-form">
          {% csrf_token %}
          
          <!-- 마이데이터 연동 섹션 -->
          <div class="form-section">
            <h4 class="form-section-title">
              <i class="fas fa-database me-2"></i>데이터 입력 방식
            </h4>
            
            <div class="data-input-options">
              <div class="option-card" id="mydataOption">
                <div class="option-header">
                  <input type="radio" name="data_source" value="mydata" id="mydataRadio" class="option-radio">
                  <label for="mydataRadio" class="option-label">
                    <i class="fas fa-magic option-icon"></i>
                    <span class="option-title">마이데이터 자동 연동</span>
                  </label>
                </div>
                <div class="option-content">
                  <p class="option-description">
                    연동된 계좌, 카드, 적금 정보를 자동으로 분석하여<br>
                    정확한 소득과 지출 패턴을 파악합니다.
                  </p>
                  <div class="option-benefits">
                    <div class="benefit-item">
                      <i class="fas fa-check benefit-icon"></i>
                      <span>실제 거래내역 기반 분석</span>
                    </div>
                    <div class="benefit-item">
                      <i class="fas fa-check benefit-icon"></i>
                      <span>12개월 소득 이력 자동 수집</span>
                    </div>
                    <div class="benefit-item">
                      <i class="fas fa-check benefit-icon"></i>
                      <span>대출, 신용카드 정보 포함</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="option-card" id="manualOption">
                <div class="option-header">
                  <input type="radio" name="data_source" value="manual" id="manualRadio" class="option-radio" checked>
                  <label for="manualRadio" class="option-label">
                    <i class="fas fa-edit option-icon"></i>
                    <span class="option-title">직접 입력</span>
                  </label>
                </div>
                <div class="option-content">
                  <p class="option-description">
                    개인 정보와 거래내역을 직접 입력하여<br>
                    맞춤형 계획을 생성합니다.
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 기본 정보 섹션 (수동 입력용) -->
          <div class="form-section" id="manualInputSection">
            <h4 class="form-section-title">
              <i class="fas fa-user me-2"></i>기본 정보
            </h4>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">월 소득 (원)</label>
                  <input type="number" name="monthly_income" class="form-control" 
                         placeholder="예: 3000000" required>
                  <div class="form-help">세후 실수령액을 입력해주세요</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">나이</label>
                  <input type="number" name="age" class="form-control" 
                         placeholder="예: 28" min="18" max="100" required>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">거주 지역</label>
                  <select name="location" class="form-control" required>
                    <option value="">지역을 선택하세요</option>
                    <option value="seoul">서울특별시</option>
                    <option value="busan">부산광역시</option>
                    <option value="incheon">인천광역시</option>
                    <option value="daegu">대구광역시</option>
                    <option value="daejeon">대전광역시</option>
                    <option value="gwangju">광주광역시</option>
                    <option value="ulsan">울산광역시</option>
                    <option value="gyeonggi">경기도</option>
                    <option value="gangwon">강원도</option>
                    <option value="chungbuk">충청북도</option>
                    <option value="chungnam">충청남도</option>
                    <option value="jeonbuk">전라북도</option>
                    <option value="jeonnam">전라남도</option>
                    <option value="gyeongbuk">경상북도</option>
                    <option value="gyeongnam">경상남도</option>
                    <option value="jeju">제주특별자치도</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">직업</label>
                  <select name="occupation" class="form-control" required>
                    <option value="">직업을 선택하세요</option>
                    <option value="freelancer">프리랜서</option>
                    <option value="employee">직장인</option>
                    <option value="business_owner">사업자</option>
                    <option value="student">학생</option>
                    <option value="public_official">공무원</option>
                    <option value="teacher">교사</option>
                    <option value="medical">의료진</option>
                    <option value="other">기타</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 거래내역 섹션 (선택사항) -->
          <div class="form-section">
            <h4 class="form-section-title">
              <i class="fas fa-credit-card me-2"></i>거래내역 분석 (선택사항)
            </h4>
            <p class="form-section-description">
              거래내역을 입력하면 더 정확한 지출 분석과 최적화 방안을 제안받을 수 있습니다.
            </p>
            
            <div class="transaction-upload">
              <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p class="upload-text">거래내역 파일을 드래그하거나 클릭하여 업로드</p>
                <p class="upload-subtext">CSV, Excel 파일 지원</p>
                <input type="file" id="transactionFile" accept=".csv,.xlsx,.xls" style="display: none;">
              </div>
              
              <div class="manual-input mt-3">
                <button type="button" class="btn btn-outline-primary" id="manualInputBtn">
                  <i class="fas fa-edit me-2"></i>수동 입력
                </button>
              </div>
            </div>
            
            <!-- 수동 입력 폼 (숨김) -->
            <div class="manual-input-form mt-3" id="manualInputForm" style="display: none;">
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">카테고리</label>
                    <select class="form-control transaction-category">
                      <option value="food">식비</option>
                      <option value="transport">교통비</option>
                      <option value="housing">주거비</option>
                      <option value="healthcare">의료비</option>
                      <option value="entertainment">문화생활</option>
                      <option value="shopping">쇼핑</option>
                      <option value="education">교육비</option>
                      <option value="other">기타</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">금액 (원)</label>
                    <input type="number" class="form-control transaction-amount" placeholder="예: 50000">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">날짜</label>
                    <input type="date" class="form-control transaction-date">
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-sm" id="addTransaction">
                <i class="fas fa-plus me-1"></i>추가
              </button>
              
              <!-- 추가된 거래내역 목록 -->
              <div class="transaction-list mt-3" id="transactionList"></div>
            </div>
            
            <input type="hidden" name="transaction_data" id="transactionData">
          </div>
          
          <!-- 제출 버튼 -->
          <div class="form-submit">
            <button type="submit" class="btn btn-hero-primary btn-lg">
              <i class="fas fa-magic me-2"></i>AI 계획 생성하기
            </button>
            <p class="submit-help">
              <i class="fas fa-info-circle me-1"></i>
              AI가 분석하여 맞춤형 자산 관리 계획을 생성합니다.
            </p>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
/* Smart Plan Generator Styles */
.smart-plan-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  overflow: hidden;
  border: 1px solid #e2e8f0;
}

.smart-plan-header {
  background: linear-gradient(135deg, #1d5091 0%, #2c5aa0 100%);
  padding: 2.5rem;
  color: white;
  text-align: center;
}

.smart-plan-title {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 1rem;
}

.smart-plan-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  margin: 0;
}

.smart-plan-form {
  padding: 2.5rem;
}

.form-section {
  margin-bottom: 2.5rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid #f1f5f9;
}

.form-section:last-of-type {
  border-bottom: none;
  margin-bottom: 0;
}

.form-section-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
}

.form-section-description {
  color: #64748b;
  font-size: 0.95rem;
  margin-bottom: 1.5rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  display: block;
}

.form-control {
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: #f9fafb;
}

.form-control:focus {
  border-color: #1d5091;
  box-shadow: 0 0 0 3px rgba(29, 80, 145, 0.1);
  background: white;
  outline: none;
}

.form-help {
  color: #6b7280;
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

/* Transaction Upload Styles */
.transaction-upload {
  margin-bottom: 1.5rem;
}

.upload-area {
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
  background: #f9fafb;
  transition: all 0.3s ease;
  cursor: pointer;
}

.upload-area:hover {
  border-color: #1d5091;
  background: #f0f4ff;
}

.upload-area.dragover {
  border-color: #1d5091;
  background: #e0f2fe;
}

.upload-icon {
  font-size: 2.5rem;
  color: #9ca3af;
  margin-bottom: 1rem;
}

.upload-text {
  font-size: 1.1rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
}

.upload-subtext {
  color: #6b7280;
  font-size: 0.9rem;
  margin: 0;
}

.manual-input-form {
  background: #f8fafc;
  border-radius: 12px;
  padding: 1.5rem;
  border: 1px solid #e2e8f0;
}

.transaction-list {
  max-height: 200px;
  overflow-y: auto;
}

.transaction-item {
  background: white;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  border: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.transaction-item-info {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.transaction-category-badge {
  background: #1d5091;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.transaction-amount {
  font-weight: 600;
  color: #1e293b;
}

.transaction-date {
  color: #64748b;
  font-size: 0.9rem;
}

.remove-transaction {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 0.8rem;
}

/* Form Submit Styles */
.form-submit {
  text-align: center;
  padding-top: 2rem;
  border-top: 1px solid #f1f5f9;
}

.btn-hero-primary {
  background: linear-gradient(135deg, #1d5091 0%, #2c5aa0 100%);
  color: white;
  border: none;
  padding: 1.25rem 3rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(29, 80, 145, 0.3);
}

.btn-hero-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(29, 80, 145, 0.4);
  color: white;
}

.submit-help {
  color: #64748b;
  font-size: 0.9rem;
  margin-top: 1rem;
  margin-bottom: 0;
}

/* Responsive */
@media (max-width: 768px) {
  .smart-plan-header {
    padding: 2rem 1.5rem;
  }
  
  .smart-plan-form {
    padding: 2rem 1.5rem;
  }
  
  .smart-plan-title {
    font-size: 1.5rem;
  }
  
  .form-section-title {
    font-size: 1.1rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('transactionFile');
    const manualInputBtn = document.getElementById('manualInputBtn');
    const manualInputForm = document.getElementById('manualInputForm');
    const addTransactionBtn = document.getElementById('addTransaction');
    const transactionList = document.getElementById('transactionList');
    const transactionData = document.getElementById('transactionData');
    
    let transactions = [];
    
    // 파일 업로드 처리
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);
    
    // 수동 입력 토글
    manualInputBtn.addEventListener('click', () => {
        manualInputForm.style.display = manualInputForm.style.display === 'none' ? 'block' : 'none';
    });
    
    // 거래내역 추가
    addTransactionBtn.addEventListener('click', addTransaction);
    
    function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    }
    
    function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    }
    
    function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    }
    
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            processFile(file);
        }
    }
    
    function processFile(file) {
        // 파일 처리 로직 (CSV/Excel 파싱)
        console.log('파일 처리:', file.name);
        // 실제 구현에서는 파일을 파싱하여 거래내역 데이터로 변환
    }
    
    function addTransaction() {
        const category = document.querySelector('.transaction-category').value;
        const amount = document.querySelector('.transaction-amount').value;
        const date = document.querySelector('.transaction-date').value;
        
        if (!amount || !date) {
            alert('금액과 날짜를 입력해주세요.');
            return;
        }
        
        const transaction = {
            category: category,
            amount: parseInt(amount),
            date: date
        };
        
        transactions.push(transaction);
        updateTransactionList();
        updateTransactionData();
        
        // 폼 초기화
        document.querySelector('.transaction-amount').value = '';
        document.querySelector('.transaction-date').value = '';
    }
    
    function updateTransactionList() {
        transactionList.innerHTML = '';
        transactions.forEach((transaction, index) => {
            const item = document.createElement('div');
            item.className = 'transaction-item';
            item.innerHTML = `
                <div class="transaction-item-info">
                    <span class="transaction-category-badge">${getCategoryName(transaction.category)}</span>
                    <span class="transaction-amount">${transaction.amount.toLocaleString()}원</span>
                    <span class="transaction-date">${transaction.date}</span>
                </div>
                <button type="button" class="remove-transaction" onclick="removeTransaction(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            transactionList.appendChild(item);
        });
    }
    
    function updateTransactionData() {
        transactionData.value = JSON.stringify(transactions);
    }
    
    function getCategoryName(category) {
        const names = {
            'food': '식비',
            'transport': '교통비',
            'housing': '주거비',
            'healthcare': '의료비',
            'entertainment': '문화생활',
            'shopping': '쇼핑',
            'education': '교육비',
            'other': '기타'
        };
        return names[category] || category;
    }
    
    window.removeTransaction = function(index) {
        transactions.splice(index, 1);
        updateTransactionList();
        updateTransactionData();
    };
});
</script>
{% endblock %}
